type: sections
max_columns: 1
title: Zagreb Transit Demo
path: zagreb-transit-demo
sections:
  - type: grid
    cards:
      - type: markdown
        title: 0) Kako koristiti ovaj demo
        content: |
          Ovaj demo je **generički** i nije vezan uz privatne lokacije.
          1. U **Postavke** kartici odaberi rutu/smjer/stanice ili station.
          2. U **Output (watch)** vidi rezultate aktivnih watch entiteta.
          3. U **Debug** provjeri feed, realtime i registry stanje.
          4. Ako nema rezultata, povećaj vremenski prozor (`window_minutes`) ili opusti filtere.

      - type: markdown
        title: 1) Objašnjenje
        content: |
          Ovaj dashboard je tehnički pregled integracije.
          - **Settings**: ručni chain + core status.
          - **Output**: svi aktivni watch outputi s točnim vremenima.
          - **Debug**: feed/realtime/watch registry dijagnostika.

      - type: entities
        title: 2) Postavke (ručni chain)
        entities:
          - entity: select.zet_route_mode
          - entity: select.zet_route
          - entity: select.zet_od_direction
          - entity: select.zet_from_stop
          - entity: select.zet_to_stop
          - entity: select.zet_station
          - entity: select.zet_direction
          - entity: select.zet_board_route
          - entity: number.zet_window_minutes
          - entity: select.zet_reference_person
          - entity: number.zet_nearby_radius_meters

      - type: markdown
        title: 2a) Što rade postavke
        content: |
          - `route_mode/route/od_*` -> ručni planner za relaciju.
          - `station/direction/board_route` -> board za jednu stanicu.
          - `reference_person/nearby_radius_meters` -> nearby board.
          - `window_minutes` -> globalni vremenski raspon rezultata.

      - type: markdown
        title: 3) Output (watch)
        content: |
          {% set rows = state_attr('sensor.zagreb_transport_watch_registry', 'watches') or [] %}
          {% if rows | count == 0 %}
          Nema konfiguriranih watch entiteta.
          {% else %}
          {% for w in rows %}
          {% set ent = w.entity_id %}
          {% set deps = state_attr(ent, 'departures') or [] %}
          {% set stations = state_attr(ent, 'stations') or [] %}
          {% set stops = state_attr(ent, 'stops') or [] %}
          **{{ w.name }}** (`{{ ent }}`)  
          tip={{ w.type }}, state={{ states(ent) }}, enabled={{ w.enabled }}{% if w.error %}, error={{ w.error }}{% endif %}

          {% if deps | count > 0 %}
          {% for d in deps[:8] %}
          {% set dep_ts = as_timestamp(d.departure_rt | default(d.rt | default(d.planned | default('')))) %}
          {% set arr_ts = as_timestamp(d.arrival_rt | default('')) %}
          - {{ dep_ts | timestamp_custom('%H:%M', true) if dep_ts else '?' }}{% if arr_ts %} -> {{ arr_ts | timestamp_custom('%H:%M', true) }}{% endif %} | linija {{ d.line | default('?') }} | {{ d.direction | default('?') }} | za {{ d.minutes | default('?') }} min
          {% endfor %}
          {% elif stations | count > 0 %}
          {% for s in stations[:4] %}
          - **{{ s.stop }}**
          {% for d in (s.departures or [])[:4] %}
            - {{ d.rt | default(d.planned | default('?')) }} | linija {{ d.line | default('?') }} | {{ d.direction | default('?') }} | za {{ d.minutes | default('?') }} min
          {% endfor %}
          {% endfor %}
          {% elif stops | count > 0 %}
          {% for s in stops[:4] %}
          - **{{ s.stop }}** ({{ s.distance_meters | default('?') }} m)
          {% for d in (s.departures or [])[:3] %}
            - {{ d.rt | default(d.planned | default('?')) }} | linija {{ d.line | default('?') }} | {{ d.direction | default('?') }} | za {{ d.minutes | default('?') }} min
          {% endfor %}
          {% endfor %}
          {% else %}
          - nema podataka u trenutnom prozoru
          {% endif %}

          {% endfor %}
          {% endif %}

      - type: entities
        title: 4) Debug
        entities:
          - entity: sensor.zagreb_transport_feed_version_active
          - entity: sensor.zagreb_transport_feed_valid_from
          - entity: sensor.zagreb_transport_feed_valid_to
          - entity: sensor.zagreb_transport_feed_source
          - entity: sensor.zagreb_transport_realtime_status
          - entity: sensor.zagreb_transport_realtime_last_timestamp
          - entity: sensor.zagreb_transport_watch_registry
          - entity: sensor.zagreb_transport_debug_info

      - type: markdown
        title: 4a) Kako čitati debug
        content: |
          - `feed_source` pokazuje koristi li se latest ili fallback feed.
          - `realtime_status` i `realtime_last_timestamp` pokazuju svježinu RT podataka.
          - `watch_registry` pokazuje aktivne dinamičke watch entitete.
          - `debug_info` sadrži detalje fallback strategije i pokušaja.

      - type: markdown
        title: 5) Debug dump
        content: |
          watch_registry:
          {{ state_attr('sensor.zagreb_transport_watch_registry', 'watches') | tojson }}

          debug:
          {{ state_attr('sensor.zagreb_transport_debug_info', 'all') | default(state_attr('sensor.zagreb_transport_debug_info', 'watch_ids')) }}
